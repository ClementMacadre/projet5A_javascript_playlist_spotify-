<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Créer une playlist</title>
	<link href="style.css" rel="stylesheet" type="text/css" media="screen"/>

	<script src="JS/jquery.min.js"></script>
	<script src="JS/jquery-ui.min.js"></script>
    <script src="JS/handlebars.js"></script>
</head>

<body>
	<div class="header">
		<img src="Pictures/Yfitops.png" onclick="window.location='playlist.html'" height="40">
		<button id="connexion" style="float:right">Connexion</button>
	</div>
	<div class="zoneHeader">
		<div id="leftzone_header" class="leftzone">
			<p>Recherche de musiques</p>
			<label for="recent_tracks">Écoutes récentes :</label>
			<button id="recent_tracks" name="recent_tracks">Valider</button>
			<br>
			<label for="user_playlists">Choix de playlist :</label>
			<select name="user_playlists">
				<option>test1 </option>
				<option>test2</option>
				<!-- Les options doivent être créer avec une requetes sur les playlistes du user-->
			</select>
			<button id="user_playlist_tracks" name="user_playlist_tracks">Valider</button>
			<form>
				<label for="research">Recherche :</label>
				<input type="text" id="research" name="research">
				<input type="submit" value="Valider">
				<!-- envoie un requete pour recherche des son avec mots clés-->
			  </form>
		</div>
		<div id="dropzone_header" class="rightzone"> 
			<p>Création et/ou modification de playlistes</p>
			<form>
				<label for="creat">Nouvelle playliste :</label>
				<input type="text" id="creat" name="creat">
				<input type="submit" value="Valider">
				<!-- envoie un requete pour recherche des son avec mots clés-->
			  </form>
			<label for="playlists">Choix de playlist à modifier :</label>
			<select name="playlists">
				<option>test3 </option>
				<option>test4</option>
				<!-- Les options doivent être créer avec une requetes sur les playlistes du user-->
			</select>
			<button id="user_playlist_tracks">Valider</button>
			<label for="delete_playlist">Suprimmer la playlist :</label>
			<button id="delete_playlist" name="delete_playlist">Valider</button>
		</div>
	</div>
	<div class="true-body">
		<div id="leftzone" class="deposer">
		</div>
		<div id="dropzone" class="deposer"> 
		</div>
	</div>

	<!-- Script drag & drop -->
	<script type="text/javascript">
		// Met à jour les éléments pouvant être bougés
		function updateDrag(){
			$(".bouger").draggable({
				revert: false,
				helper: "clone",
				cancel: ".song-image .song-artist .song-title .trash .play",
			});

			// A améliorer (l'élément déplacé disparaît)
			$('.drag-vertical').draggable({
				axis: 'y',
				handle: '.move',
				containment: ('.true-body'),
				scroll: true,
				scrollSensitivity: 30,
				scrollSpeed: 30,

				helper: function(){
					// Pour bouger toute la div et non uniquement le logo
					return this.parentElement;
				}
			});
		}

		$(".deposer").droppable({ 
			accept:function(d){
				// Accepter uniquement les éléments contenant la classe bouger ou drag-vertical
				if(d.hasClass("drag-vertical") || d.hasClass("bouger")){
					return true;
				}
			},
			
			drop:function(event, ui){
				if(ui.draggable.attr('class').includes('drag-vertical')){
					// Si le dépot concerne le changement d'index
					let zone = ui.draggable.parent().parent().attr('id');
					switchIndex(event, ui, zone);
				}else{
					// Si le dépot concerne le déplacement vers une autre zone
					let zone = ui.draggable.parent().attr('id');
					// Si l'élément est droppé sur la zone d'où il vient on sort de la fonction
					if(zone == this.id){
						return;
					}
					let id = ui.draggable.attr('id');
					if(zone === 'dropzone'){
						cloneImage(ui, "#leftzone", id);
					}
					else{
						cloneImage(ui, "#dropzone", id);
					}
				}
			}
		});

		function switchIndex(event, ui, zone){
			var nextSong;

			// On récupère la position de l'élément lâché
			const selectedPos = ui.offset.top;

			// On calcule sa nouvelle position dans la liste des chansons
			$('#' + zone + ' .drag-vertical').map(function(){
				let elemPos = this.offsetTop;
				if(elemPos > selectedPos){
					if(nextSong == undefined || elemPos < nextSong.offsetTop){
						nextSong = this.parentElement;
					}
				}
			});

			let imgSrc = '';
			let title = '';
			let artist = '';
			// On récupère les infos de la div déplacée pour la recréer ensuite
			ui.draggable[0].childNodes.forEach(function(node){
				if(node.className.includes('song-image')){
					imgSrc = node.getAttribute('src');
				}
				if(node.className.includes('song-title')){
					title = node.textContent;
				}
				if(node.className.includes('song-artist')){
					artist = node.textContent;
				}
			});

			if(nextSong == undefined){
				// Si il n'est pas défini, sa position est tout à la fin, donc on appelle la fonction addSong qui fait le travail
				addSong(zone, imgSrc, title, artist);
			}
			else{
				// Appel à l'API Spotify pour mettre à jour la liste
				// Pour l'index : var index = Array.from(child.parentNode.children).indexOf(child);
				// C'est l'index de la chanson inséeré qui est calculé ici, tous les suivants ont leur précédent+1

				let newID = (title + ' ' + artist).replaceAll(' ', '-').toLowerCase();

				// Insérer l'élément à sa nouvelle position
				// On change le append par un before l'élément calculé nextSong
				$('#' + zone + ' #' + nextSong.id).before($(document.createElement('div'))
					// Mettre l'ID de la chanson sur l'API
					.attr({ 'id' : newID })
					.addClass('bouger')
					.append($(document.createElement('div'))
						.addClass('song drag-vertical')
						.append($(document.createElement('img'))
							.attr({ src : 'Pictures/Hamburger_icon.svg'})
							.addClass('move')
						)
					    .append($(document.createElement('img'))
					        .attr({ src : imgSrc })
					        .addClass('song-image')
					    )
					    .append($(document.createElement('p'))
					    	.addClass('song-title')
					    	.text(title)
					    )
					    .append($(document.createElement('p'))
					    	.addClass('song-artist')
					    	.text(artist))
						.append($(document.createElement('img'))
							.attr({ src : 'Pictures/trash.svg',})
							.attr('onClick', 'deleteSong(this)')
							.addClass('trash')
						)
						.append($(document.createElement('img'))
							.attr({ src : 'Pictures/play.svg'})
							// L'argument peut être modifié en fonction des besoins de l'API Spotify
							.attr('onClick', 'playSong(this.parentElement)')
							.addClass('play')
						)
					)	
				);
				updateDrag();
			}
			
		}
		
		function cloneImage(ui, zone, id){
			let idExists = false;
			// On parcourt toutes les images dans la zone pour vérifier que l'image n'existe pas déjà
			$(zone + ' > .bouger').map(function(){
				if(this.id == id){
					idExists = true;
				}
			});
			// Ici est gérée la logique à appliquer lors du drop d'une image
			if(!idExists){
				// Gestion de la nouvelle image (en récupérant l'image déposée)
				newImage = ui.draggable.clone();
				$(zone).append(newImage);
				updateDrag();
			}
		}
	</script>

	<!-- Script add div -->
	<script type="text/javascript">
		function addSong(zone, imgSrc, title, artist){
			let newID = (title + ' ' + artist).replaceAll(' ', '-').toLowerCase();
			console.log(newID)
			$('#' + zone).append($(document.createElement('div'))
				.attr({ 'id' : newID })
				.addClass('bouger')
				.append($(document.createElement('div'))
					.addClass('song drag-vertical')
					.append($(document.createElement('img'))
						.attr({ src : 'Pictures/Hamburger_icon.svg'})
						.addClass('move')
					)
				    .append($(document.createElement('img'))
				        .attr({ src : imgSrc })
				        .addClass('song-image')
				    )
				    .append($(document.createElement('p'))
				    	.addClass('song-title')
				    	.text(title)
				    )
				    .append($(document.createElement('p'))
				    	.addClass('song-artist')
				    	.text(artist))
					.append($(document.createElement('img'))
						.attr({ src : 'Pictures/trash.svg',})
						.attr('onClick', 'deleteSong(this)')
						.addClass('trash')
					)
					.append($(document.createElement('img'))
						.attr({ src : 'Pictures/play.svg'})
						// L'argument peut être modifié en fonction des besoins de l'API Spotify
						.attr('onClick', 'playSong(this.parentElement)')
						.addClass('play')
					)
				)	
			);
			updateDrag();
		}

		function deleteSong(e){
			// Appel à l'API Spotify pour mettre à jour la playlist
			e.parentElement.remove();
		}

		// Ajouter dans la zone de gauche
		addSong('leftzone', 'Pictures/itcotck.jpg', '21st Century Schizoid man', 'King Crimson');
		addSong('leftzone', 'Pictures/lctc.jpg', 'London Calling', 'The Clash');
		addSong('leftzone', 'Pictures/animals.jpg', 'Dogs', 'Pink Floyd');
		addSong('leftzone', 'Pictures/nvm.jpg', 'Smells like teen spirit', 'Nirvava');
		addSong('leftzone', 'Pictures/mwr.jpg','Warriors of the world','Man O War');
		addSong('leftzone', 'Pictures/dangerousd.jpg','Future club','Perturbator');

		// Ajouter dans la zone de droite
		addSong('dropzone', 'Pictures/mwr.jpg','Warriors of the world','Man O War');
		addSong('dropzone', 'Pictures/dangerousd.jpg','Future club','Perturbator');
	</script>

	<script type="text/javascript">
		function playSong(divId){
			alert('playing: ' + divId.parentElement.id);
			// Avec ce parent, on peut facilement retrouver des infos sur la chanson à jouer
		}
	</script>

	<!-- Script Connexion -->
	<script type="text/javascript">
		var loginButton = document.getElementById('connexion');

		loginButton.addEventListener('click', function() {
			login(function(accessToken) {
	            getUserData(accessToken)
	                .then(function(response) {
	                    loginButton.style.display = 'none';
	                    resultsPlaceholder.innerHTML = template(response);
	                });
	            });
	    });

		function login(callback) {
			var CLIENT_ID = '6b284830006843e7ae7b170725715aed';
			var REDIRECT_URI = 'http://jmperezperez.com/spotify-oauth-jsfiddle-proxy/';
			
			function getLoginURL(scopes) {
			    return 'https://accounts.spotify.com/authorize?client_id=' + CLIENT_ID +
			      '&redirect_uri=' + encodeURIComponent(REDIRECT_URI) +
			      '&scope=' + encodeURIComponent(scopes.join(' ')) +
			      '&response_type=token';
			}

			var url = getLoginURL([
			    'user-read-email'
			]);

			var width = 450,
			    height = 730,
			    left = (screen.width / 2) - (width / 2),
			    top = (screen.height / 2) - (height / 2);

			window.addEventListener("message", function(event) {
			    var hash = JSON.parse(event.data);
			    if (hash.type == 'access_token') {
			        callback(hash.access_token);
			    }
			}, false);

			var w = window.open(url,
			                    'Spotify',
			                    'menubar=no,location=no,resizable=no,scrollbars=no,status=no, width=' + width + ', height=' + height + ', top=' + top + ', left=' + left
			                   );
		}

	    function getUserData(accessToken) {
	        return $.ajax({
	            url: 'https://api.spotify.com/v1/me',
	            headers: {
	               'Authorization': 'Bearer ' + accessToken
	            }
	        });
	    }
	</script>
</body>
</html>
